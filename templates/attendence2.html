<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Face Attendance System</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: #f8f9fa;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    .navbar {
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
    }

    .navbar-brand {
      color: white;
      font-weight: bold;
      font-size: 1.8rem;
    }

    .navbar-nav .nav-link {
      color: white !important;
      font-size: 1.1rem;
    }

    .navbar-nav .nav-link:hover {
      color: #ffc107 !important;
    }

    .card {
      margin-top: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      border: none;
    }

    .card-body {
      padding: 2rem;
    }

#video-container {
  position: relative;
  width: 100%;
  max-width: 400px;
  aspect-ratio: 4/3;
  margin: 0 auto; /* ✅ centers horizontally */
  display: flex;
  justify-content: center;
  align-items: center;
}


    #video, #canvas {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 10px;
      border: 2px solid #343a40;
    }

    .btn-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .btn-container button {
      min-width: 120px;
    }

    footer.footer {
      background-color: #343a40;
      color: white;
      text-align: center;
      padding: 12px 0;
      margin-top: auto;
    }

    #wait-message, #liveness-message {
      margin-top: 10px;
    }

    @media (max-width: 576px) {
      .btn-container {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <!-- Navbar -->
<nav class="navbar navbar-expand-lg">
  <a class="navbar-brand" href="#">Attendance</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon text-white">☰</span>
  </button>

  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item"><a class="nav-link" href="{% url 'success_page' %}">Home</a></li>
    </ul>
  </div>
</nav>


  <!-- Main Container -->
  <div class="container">
    <div class="card">
      <div class="card-body text-center">
        <div id="video-container">
          <video id="video" autoplay playsinline muted style="transform: scaleX(-1);"></video>
          <canvas id="canvas" style="display:none;"></canvas>
        </div>

        <div class="btn-container mt-3">
          <button class="btn btn-primary" onclick="switchCamera()">Switch Camera</button>
        </div>

        <form method="POST" enctype="multipart/form-data" id="attendance-form">
          {% csrf_token %}
          <input type="hidden" name="clickedImg" id="clickedImg">
          <input type="hidden" name="actionType" id="actionType">

          <div class="form-group mt-3">
            <input type="text" class="form-control" name="empId" placeholder="Enter Emp ID" required />
          </div>

          <p id="wait-message" class="text-danger" style="display: none;">Processing...</p>
          <p id="liveness-message" class="text-info" style="display: none;">Please blink to confirm liveness.</p>

          <div class="btn-container">
            <button type="button" class="btn btn-success" onclick="capturePhoto('signin')" id="signin-btn" disabled>Sign In</button>
            <button type="button" class="btn btn-danger" onclick="capturePhoto('signout')" id="signout-btn" disabled>Sign Out</button>
          </div>
        </form>

        <div id="response" class="mt-3"></div>
      </div>
    </div>

    <div id="names-section" class="text-center mt-4"></div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>&copy; 2025 Face Attendance System</p>
  </footer>

  <!-- JS Libraries -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <!-- Main JS -->
  <script>
    const video = document.getElementById("video");
    const clickedImgInput = document.getElementById("clickedImg");
    const actionTypeInput = document.getElementById("actionType");
    const waitMessage = document.getElementById("wait-message");
    const signinBtn = document.getElementById("signin-btn");
    const signoutBtn = document.getElementById("signout-btn");
    const attendanceForm = document.getElementById("attendance-form");

    let currentStream = null;
    let videoDevices = [];
    let currentDeviceIndex = 0;

    async function getVideoDevices() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      return devices.filter((device) => device.kind === "videoinput");
    }

    async function startVideo(deviceId = null) {
      if (currentStream) {
        currentStream.getTracks().forEach((track) => track.stop());
      }

      const constraints = {
        video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: "user" }
      };

      try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          signinBtn.disabled = false;
          signoutBtn.disabled = false;
        };
      } catch (err) {
        alert("Error accessing camera: " + err.message);
      }
    }

    async function switchCamera() {
      currentDeviceIndex = (currentDeviceIndex + 1) % videoDevices.length;
      await startVideo(videoDevices[currentDeviceIndex].deviceId);
    }

    function capturePhoto(action) {
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
      clickedImgInput.value = canvas.toDataURL("image/png");
      actionTypeInput.value = action;
      submitForm();
    }

    async function getAddress(lat, lon) {
  const apiKeys = [
    "4611008aa9f1d84aff37600fd7ba681f",
    "9c82d1a53a3c60dc1ef7762fd58d4038",
    "6e361438746645b6612d080553fec1b0" // You can add the 3rd API key here
  ];

  for (const apiKey of apiKeys) {
    if (!apiKey) continue; // skip if empty

    const url = `https://apis.mapmyindia.com/advancedmaps/v1/${apiKey}/rev_geocode?lat=${lat}&lng=${lon}`;
    try {
      const res = await fetch(url);

      if (res.status === 200) {
        const data = await res.json();
        return data.results?.[0]?.formatted_address || "Unknown location";
      }
    } catch (error) {
      console.warn(`API key failed: ${apiKey}`, error);
    }
  }

  return "Unknown location";
}


    async function submitForm() {
      waitMessage.style.display = "block";
      const formData = new FormData(attendanceForm);

      try {
        const pos = await new Promise((resolve, reject) =>
          navigator.geolocation.getCurrentPosition(resolve, reject)
        );

        formData.set("latitude", pos.coords.latitude);
        formData.set("longitude", pos.coords.longitude);
        const address = await getAddress(pos.coords.latitude, pos.coords.longitude);
        formData.set("address", address);

        const response = await fetch(attendanceForm.action, {
          method: "POST",
          body: formData
        });

        const data = await response.json();
        document.getElementById("names-section").innerHTML = data.namesList
          ? `<h6>Detected Names:</h6><ul>${data.namesList.map(name => `<li>${name}</li>`).join("")}</ul>`
          : "<p>No names detected.</p>";
      } catch (err) {
        alert("Error: " + err.message);
      } finally {
        waitMessage.style.display = "none";
      }
    }

    async function init() {
      videoDevices = await getVideoDevices();
      await startVideo(videoDevices.length ? videoDevices[0].deviceId : null);
    }

    init();
  </script>
</body>
</html>



